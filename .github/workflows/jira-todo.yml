name: Sync Jira To Do tickets

on:
  workflow_dispatch: # run manually; add schedule if you like

permissions:
  contents: write # to push changes

jobs:
  sync-todo:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Fetch Jira To Do issues and create files
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
        run: |
          sudo apt-get update
          sudo apt-get install -y jq nodejs npm

          npm install -g @atlaskit/adf-to-markdown

          mkdir -p .story/backlog/todo

          jql='project = SCRUM AND status = "To Do" ORDER BY created ASC'
          echo "Using JQL: $jql"

          body=$(jq -n --arg jql "$jql" '
            {
              jql: $jql,
              fields: ["summary", "description"],
              maxResults: 100
            }')

          response=$(curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            -X POST \
            -H "Content-Type: application/json" \
            --data "$body" \
            "$JIRA_BASE_URL/rest/api/3/search/jql")

          echo "$response" | jq -e '.issues' >/dev/null

          echo "$response" | jq -c '.issues[]' | while read -r issue; do
            key=$(echo "$issue" | jq -r '.key')
            summary=$(echo "$issue" | jq -r '.fields.summary')
            description_adf=$(echo "$issue" | jq -c '.fields.description // empty')

            safe_summary=$(echo "$summary" | tr ' /' '__' | cut -c1-40)
            file=".story/backlog/todo/${key}-${safe_summary}.md"

            if [ -n "$description_adf" ]; then
              description_md=$(echo "$description_adf" | adf-to-md)
            else
              description_md="_No description provided._"
            fi

            {
              echo "# $key - $summary"
              echo
              echo "$description_md"
            } > "$file"

            echo "Wrote $file"
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # if git diff --quiet; then
          #   echo "No changes to commit"
          #   exit 0
          # fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .story/backlog/todo
          git status
          git commit -m "chore: Sync Jira To Do tickets"
          git push
