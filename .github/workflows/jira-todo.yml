name: Sync Jira To Do tickets

on:
  workflow_dispatch: # run manually; add schedule if you like

permissions:
  contents: write # to push changes

jobs:
  sync-todo:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Fetch Jira To Do issues and create files
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
        run: |
          mkdir -p .story/backlog/todo

          jql='project = SCRUM AND status = "To Do" ORDER BY created ASC'
          echo "Using JQL: $jql"

          body=$(jq -n --arg jql "$jql" '
            {
              jql: $jql,
              fields: ["summary", "description", "issuetype", "status", "customfield_10014", "priority", "reporter", "assignee", "labels", "created"],
              maxResults: 100
            }')

          response=$(curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            -X POST \
            -H "Content-Type: application/json" \
            --data "$body" \
            "$JIRA_BASE_URL/rest/api/3/search/jql")

          echo "$response" | jq -e '.issues' >/dev/null

          echo "$response" | jq -c '.issues[]' | while read -r issue; do
            key=$(echo "$issue" | jq -r '.key')
            summary=$(echo "$issue" | jq -r '.fields.summary')
            description=$(echo "$issue" | jq -c '.fields.description // empty')
            issue_url="${JIRA_BASE_URL}/browse/${key}"
            issuetype=$(echo "$issue" | jq -r '.fields.issuetype.name')
            status=$(echo "$issue" | jq -r '.fields.status.name')
            epic=$(echo "$issue" | jq -r '.fields.customfield_10014 // "N/A"')
            priority=$(echo "$issue" | jq -r '.fields.priority.name // "N/A"')
            labels=$(echo "$issue" | jq -r '.fields.labels | join(", ") // "N/A"')
            created=$(echo "$issue" | jq -r '.fields.created')
            safe_summary=$(echo "$summary" | tr ' /' '__' | cut -c1-40)
            file_base="${key}-${safe_summary}"
            todo_file=".story/backlog/todo/${file_base}.md"

            # Store metadata + raw Jira JSON for conversion
            if [ -n "$description" ]; then
              {
                echo "# $key - $summary"
                echo
                echo "---"
                echo "Jira: [$key]($issue_url)"
                echo "Title: $summary"
                echo "Type: $issuetype"
                echo "Status (Jira): $status"
                echo "Epic: $epic"
                echo "Priority: $priority"
                echo "Labels: $labels"
                echo "Created: $created"
                echo "Imported: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
                echo "---"
                echo
                echo '```json'
                echo "$description"
                echo '```'
              } > "$todo_file"
            else
              {
                echo "# $key - $summary"
                echo
                echo "---"
                echo "Jira: [$key]($issue_url)"
                echo "Key: $key"
                echo "Title: $summary"
                echo "Type: $issuetype"
                echo "Status (Jira): $status"
                echo "Epic: $epic"
                echo "Priority: $priority"
                echo "Labels: $labels"
                echo "Created: $created"
                echo "Imported: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
                echo "---"
                echo
                echo "_No description provided._"
              } > "$todo_file"
            fi

            echo "Wrote $todo_file"
            echo "---- RAW: $todo_file"
            cat "$todo_file"
          done

      - name: Convert Jira files to clean markdown
        run: |
          npm install -g tsx

          # Convert each file in-place (overwrites with clean markdown)
          for file in .story/backlog/todo/*.md; do
            if [ -f "$file" ]; then
              if npx tsx scripts/jira-to-markdown.ts "$file"; then
                echo "---- FORMATTED: $file"
                cat "$file"
              else
                echo "Skipped non-Jira file: $file"
              fi
            fi
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .story/backlog/
          git status

          # if git diff --cached --quiet; then
          #   echo "No changes to commit"
          #   exit 0
          # fi

          git commit -m "chore: Sync Jira To Do tickets"
          git push
