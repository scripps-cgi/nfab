---
name: Sync Jira To Do tickets

on:
  workflow_dispatch: {}  # run manually; add schedule if you like

permissions:
  contents: write  # to push changes

jobs:
  sync-todo:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Fetch Jira To Do issues and create files
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
        run: |
          mkdir -p .story/backlog/todo

          # 1) Fetch all To Do STORIES (parents)
          jql='project = SCRUM AND issuetype = Story AND status = "To Do" ORDER BY created ASC'
          echo "Using JQL for stories: $jql"

          body=$(jq -n --arg jql "$jql" '
            {
              jql: $jql,
              fields: ["summary", "description", "issuetype", "status", "customfield_10014", "priority", "reporter", "assignee", "labels", "created"],
              maxResults: 100
            }')

          # Call Jira API and capture response; don't let curl's exit code abort the whole step
          response=$(curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            -X POST \
            -H "Content-Type: application/json" \
            --data "$body" \
            "$JIRA_BASE_URL/rest/api/3/search/jql" || true)

          # If Jira returned an error payload, surface it clearly and fail
          # Detect common Jira error payload keys without depending on jq expression quoting
          if echo "$response" | grep -q '"errorMessages"' || echo "$response" | grep -q '"errors"'; then
            echo "Jira API error response:"
            echo "$response" | jq '.' || echo "$response"
            exit 1
          fi

          # If no issues array was returned (or it's empty), normalize to an empty issues list
          if ! echo "$response" | jq -e '.issues' >/dev/null 2>&1; then
            echo "No issues returned by Jira for the stories query. Continuing with zero results."
            response='{"issues": []}'
          fi

          # 1a) Create files for STORIES
          echo "$response" | jq -c '.issues[]' | while read -r issue; do
            key=$(echo "$issue" | jq -r '.key')
            summary=$(echo "$issue" | jq -r '.fields.summary')
            description=$(echo "$issue" | jq -c '.fields.description // empty')
            issue_url="${JIRA_BASE_URL}/browse/${key}"
            issuetype=$(echo "$issue" | jq -r '.fields.issuetype.name')
            status=$(echo "$issue" | jq -r '.fields.status.name')
            epic=$(echo "$issue" | jq -r '.fields.customfield_10014 // "N/A"')
            priority=$(echo "$issue" | jq -r '.fields.priority.name // "N/A"')
            labels=$(echo "$issue" | jq -r '.fields.labels | join(", ") // "N/A"')
            created=$(echo "$issue" | jq -r '.fields.created')
            safe_summary=$(echo "$summary" | tr ' /' '__' | cut -c1-40)
            file_base="${key}-${safe_summary}"
            todo_file=".story/backlog/todo/${file_base}.md"

            if [ -n "$description" ]; then
              {
                echo "# $key - $summary"
                echo
                echo "---"
                echo "Jira: [$key]($issue_url)"
                echo "Title: $summary"
                echo "Type: $issuetype"
                echo "Status (Jira): $status"
                echo "Epic: $epic"
                echo "Priority: $priority"
                echo "Labels: $labels"
                echo "Created: $created"
                echo "Imported: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
                echo "---"
                echo
                echo '\'\'\'json'
                echo "$description"
                echo '\'\'\''
              } > "$todo_file"
            else
              {
                echo "# $key - $summary"
                echo
                echo "---"
                echo "Jira: [$key]($issue_url)"
                echo "Title: $summary"
                echo "Type: $issuetype"
                echo "Status (Jira): $status"
                echo "Epic: $epic"
                echo "Priority: $priority"
                echo "Labels: $labels"
                echo "Created: $created"
                echo "Imported: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
                echo "---"
                echo
                echo "_No description provided._"
              } > "$todo_file"
            fi

            echo "Wrote story file: $todo_file"
          done

          # 2) Build comma-separated list of STORY keys to fetch their SUB-TASKS
          story_keys=$(echo "$response" | jq -r '.issues[].key' | paste -sd "," -)
          echo "Story keys for sub-task lookup: $story_keys"

          if [ -n "$story_keys" ]; then
            # 3) Fetch all SUB-TASKS whose parent is one of the To Do stories
            sub_jql="project = SCRUM AND issuetype = Sub-task AND parent in ($story_keys)"
            echo "Using JQL for subtasks: $sub_jql"

            sub_body=$(jq -n --arg jql "$sub_jql" '
              {
                jql: $jql,
                fields: ["summary", "description", "issuetype", "status", "customfield_10014", "priority", "reporter", "assignee", "labels", "created", "parent"],
                maxResults: 100
              }')

            sub_response=$(curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
              -X POST \
              -H "Content-Type: application/json" \
              --data "$sub_body" \
              "$JIRA_BASE_URL/rest/api/3/search/jql" || true)

            if echo "$sub_response" | grep -q '"errorMessages"' || echo "$sub_response" | grep -q '"errors"'; then
              echo "Jira API error response when fetching subtasks:"
              echo "$sub_response" | jq '.' || echo "$sub_response"
              exit 1
            fi

            if ! echo "$sub_response" | jq -e '.issues' >/dev/null 2>&1; then
              echo "No subtasks returned by Jira for the subtask query. Continuing with zero results."
              sub_response='{"issues": []}'
            fi

            # 3a) Create files for SUB-TASKS
            echo "$sub_response" | jq -c '.issues[]' | while read -r issue; do
              key=$(echo "$issue" | jq -r '.key')
              summary=$(echo "$issue" | jq -r '.fields.summary')
              description=$(echo "$issue" | jq -c '.fields.description // empty')
              issue_url="${JIRA_BASE_URL}/browse/${key}"
              issuetype=$(echo "$issue" | jq -r '.fields.issuetype.name')
              status=$(echo "$issue" | jq -r '.fields.status.name')
              epic=$(echo "$issue" | jq -r '.fields.customfield_10014 // "N/A"')
              priority=$(echo "$issue" | jq -r '.fields.priority.name // "N/A"')
              labels=$(echo "$issue" | jq -r '.fields.labels | join(", ") // "N/A"')
              created=$(echo "$issue" | jq -r '.fields.created')
              parent_key=$(echo "$issue" | jq -r '.fields.parent.key')

              safe_summary=$(echo "$summary" | tr ' /' '__' | cut -c1-40)
              # Include parent key in filename so hierarchy is obvious
              file_base="${parent_key}__${key}-${safe_summary}"
              todo_file=".story/backlog/todo/${file_base}.md"

              if [ -n "$description" ]; then
                {
                  echo "# $key (Sub-task of $parent_key) - $summary"
                  echo
                  echo "---"
                  echo "Jira: [$key]($issue_url)"
                  echo "Parent: $parent_key"
                  echo "Title: $summary"
                  echo "Type: $issuetype"
                  echo "Status (Jira): $status"
                  echo "Epic: $epic"
                  echo "Priority: $priority"
                  echo "Labels: $labels"
                  echo "Created: $created"
                  echo "Imported: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
                  echo "---"
                  echo
                  echo '\'\'\'json'
                  echo "$description"
                  echo '\'\'\''
                } > "$todo_file"
              else
                {
                  echo "# $key (Sub-task of $parent_key) - $summary"
                  echo
                  echo "---"
                  echo "Jira: [$key]($issue_url)"
                  echo "Parent: $parent_key"
                  echo "Title: $summary"
                  echo "Type: $issuetype"
                  echo "Status (Jira): $status"
                  echo "Epic: $epic"
                  echo "Priority: $priority"
                  echo "Labels: $labels"
                  echo "Created: $created"
                  echo "Imported: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
                  echo "---"
                  echo
                  echo "_No description provided._"
                } > "$todo_file"
              fi

              echo "Wrote sub-task file: $todo_file"
            done
          else
            echo "No story keys found; skipping sub-task fetch."
          fi

      - name: Convert Jira files to clean markdown
        run: |
          npm install -g tsx

          # Convert each file in-place (overwrites with clean markdown)
          for file in .story/backlog/todo/*.md; do
            if [ -f "$file" ]; then
              if npx tsx scripts/jira-to-markdown.ts "$file"; then
                echo "---- FORMATTED: $file"
                cat "$file"
              else
                echo "Skipped non-Jira file: $file"
              fi
            fi
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .story/backlog/
          git status

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: Sync Jira To Do tickets"
          git push
